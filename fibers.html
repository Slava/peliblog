<!DOCTYPE html>
<html lang="en">

<head>
  <!-- <link rel="stylesheet/less" type="text/css" href="http://devblog.me/theme/css/style.less"> -->
  <!-- <script src="http://devblog.me/theme/js/less-1.5.0.min.js" type="text/javascript"></script> -->
  <link rel="stylesheet" type="text/css" href="http://devblog.me/theme/css/style.css">

  <link rel="stylesheet" type="text/css" href="http://devblog.me/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Slava Kim">
  <meta name="description" content="Posts and writings by Slava Kim">


    
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type= "text/javascript">
       MathJax.Hub.Config({
           config: ["MMLorHTML.js"],
           jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML"],
           TeX: { extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"], equationNumbers: { autoNumber: "AMS" } },
           extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js"],
           tex2jax: { 
               inlineMath: [ ['$','$'] ],
               displayMath: [ ['$$','$$'] ],
               processEscapes: true },
           "HTML-CSS": {
               styles: { ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
           }
       });
    </script>


<meta name="keywords" content="">

  <title>
Fibers  </title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37747647-1', 'http://devblog.me');
  ga('send', 'pageview');

</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="http://devblog.me">
        <img src="http://devblog.me/theme/images/logo.png" alt="logo">
      </a>
      <h2><a href="http://devblog.me">Slava Kim</a></h2>
      <p>Learning to code since 2008</p>
      <ul>
        <li><a href="https://github.com/slava" target="_blank">My GitHub</a></li>
        <li><a href="https://twitter.com/imslavko" target="_blank">Me on Twitter</a></li>
        <li><a href="http://slv.io/" target="_blank">More about me</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
<p>Posted on Fri 24 May 2013</p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="http://devblog.me/fibers.html">Fibers</a></h1>
  </div>
  <div class="article_text">
    <h2>What</h2>
<p><code>Fibers</code> is an npm module developed with C++. It is another flow control library like async, nue, batch, cascade, then, afuture and others. The biggest disadvantage of <code>Fibers</code> - they work only inside node.js. It is applicable only on server and will never work in your browser (at least because it is very JS engine specific library).
Checkout <a href="https://github.com/laverdet/node-fibers">the repo on Github</a>.</p>
<p>This library implements <a href="http://en.wikipedia.org/wiki/Coroutine">coroutines</a>. I imagine each fiber as a light-weight thread(for normal people these two words might mean the same thing) but fibers use co-operative multitasking. Fibers don't run simultaniously, each fiber takes its time to accomplish something small and then yields the execution flow to other fibers and waits for next time it is given control.</p>
<h2>Why</h2>
<p>The main reason I see anyone using some flow control library by default: every I/O function in node.js (file system reads/writes, web requests, database access) is an asynchronous function that invokes a callback on success or error.</p>
<p>First of all, your code may end up looking really ugly. Writing a quick code you may consider <a href="http://callbackhell.com/">pyramids of callbacks</a> 'good enough' but once your application gets bigger, fatter or more serious you will need to manage it with more named functions, use less lambda functions or use a flow control library.</p>
<p>People found some some approaches: futures, promises, signals. All are the same thing: some abstract object representing an action (or set of actions) running.</p>
<p>The second reason could be a reasonable substitution for threads. Fibers can give you some sort of multitasking in single-threaded Javascript.</p>
<h2>How</h2>
<p>After you get <code>Fibers</code> npm module you can start:</p>
<div class="highlight"><pre><span class="nv">$ </span>npm install fibers
</pre></div>


<p>Require fibers library like anything else:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Fiber</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fibers&#39;</span><span class="p">);</span>
</pre></div>


<p>To create a fiber just pass any function:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">fiber</span> <span class="o">=</span> <span class="nx">Fiber</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;I am inside fibers&#39;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>


<p>You can run it invoking the <code>run</code> method:</p>
<div class="highlight"><pre><span class="nx">fiber</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
</pre></div>


<p>You can get the instance of fiber you are running in object <code>Fiber.current</code> and get the number of running fibers by accessing <code>Fiber.fibersCreated</code>.</p>
<p>There is the third member available: <code>yield</code>. That is where magic happens. It gives control to the caller of fiber. Everything you had in stack on fiber will be remain untouched and accessible when you will run the fiber next time. Once fiber function returns it will roll back to its original state - empty stack.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">Fiber</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
    <span class="nx">Fiber</span><span class="p">.</span><span class="nx">yield</span><span class="p">();</span>
    <span class="nx">n</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
    <span class="nx">Fiber</span><span class="p">.</span><span class="nx">yield</span><span class="p">();</span>
    <span class="nx">n</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
<span class="p">});</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Will run the fiber: &#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<p>Running this code will give you following output:</p>
<div class="highlight"><pre><span class="n">Will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">fiber</span><span class="o">:</span> <span class="mi">0</span>
<span class="mi">0</span>
<span class="n">Will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">fiber</span><span class="o">:</span> <span class="mi">1</span>
<span class="mi">1</span>
<span class="n">Will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">fiber</span><span class="o">:</span> <span class="mi">2</span>
<span class="mi">2</span>
<span class="n">Will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">fiber</span><span class="o">:</span> <span class="mi">3</span>
<span class="mi">0</span>
<span class="n">Will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">fiber</span><span class="o">:</span> <span class="mi">4</span>
<span class="mi">1</span>
</pre></div>


<p>You can see how the fiber preserves the stack vars and starts over when it returns. We could show a bit more complicated example to prove that the whole stack is preserved.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">Fiber</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ff</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span>
        <span class="nx">Fiber</span><span class="p">.</span><span class="nx">yield</span><span class="p">();</span>
        <span class="nx">m</span><span class="o">--</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">ff</span><span class="p">();</span>
    <span class="nx">Fiber</span><span class="p">.</span><span class="nx">yield</span><span class="p">();</span>
    <span class="nx">n</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">ff</span><span class="p">();</span>
<span class="p">});</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Will run the fiber: &#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<div class="highlight"><pre><span class="n">Will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">fiber</span><span class="o">:</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="mi">0</span>
<span class="n">Will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">fiber</span><span class="o">:</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">Will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">fiber</span><span class="o">:</span> <span class="mi">2</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="n">Will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">fiber</span><span class="o">:</span> <span class="mi">3</span>
<span class="mi">1</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">Will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">fiber</span><span class="o">:</span> <span class="mi">4</span>
<span class="mi">0</span> <span class="mi">0</span>
</pre></div>


<p>The next thing to learn is how to pass new values inside fiber: you can invoke the <code>run</code> method with an argument. This argument will be returned by <code>yield</code>.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">Fiber</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;passed %s, get something new&#39;</span><span class="p">,</span> <span class="nx">s</span><span class="p">);</span>
    <span class="nx">s</span> <span class="o">=</span> <span class="nx">Fiber</span><span class="p">.</span><span class="nx">yield</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;now it is %s!&#39;</span><span class="p">,</span> <span class="nx">s</span><span class="p">);</span>
<span class="p">});</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="s1">&#39;string number &#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<div class="highlight"><pre><span class="n">passed</span> <span class="n">string</span> <span class="n">number</span> <span class="mi">0</span><span class="p">,</span> <span class="n">get</span> <span class="n">something</span> <span class="n">new</span>
<span class="n">now</span> <span class="n">it</span> <span class="n">is</span> <span class="n">string</span> <span class="n">number</span> <span class="mi">1</span><span class="o">!</span>
<span class="n">passed</span> <span class="n">string</span> <span class="n">number</span> <span class="mi">2</span><span class="p">,</span> <span class="n">get</span> <span class="n">something</span> <span class="n">new</span>
<span class="n">now</span> <span class="n">it</span> <span class="n">is</span> <span class="n">string</span> <span class="n">number</span> <span class="mi">3</span><span class="o">!</span>
<span class="n">passed</span> <span class="n">string</span> <span class="n">number</span> <span class="mi">4</span><span class="p">,</span> <span class="n">get</span> <span class="n">something</span> <span class="n">new</span>
</pre></div>


<p>Similarly you can pass some argument to <code>yield</code> and it will be returned by <code>run</code> command. Now we can create a generator:</p>
<div class="highlight"><pre><span class="c1">// next - how many jumps further we want to make</span>
<span class="kd">var</span> <span class="nx">factorialGenerator</span> <span class="o">=</span> <span class="nx">Fiber</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">factorial</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// default number of jumps to 1</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">next</span> <span class="o">===</span> <span class="s1">&#39;underfined&#39;</span><span class="p">)</span>
            <span class="nx">next</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">next</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">factorial</span> <span class="o">*=</span> <span class="nx">i</span><span class="p">;</span>
            <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">next</span> <span class="o">=</span> <span class="nx">Fiber</span><span class="p">.</span><span class="nx">yield</span><span class="p">(</span><span class="nx">factorial</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">f3</span> <span class="o">=</span> <span class="nx">factorialGenerator</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">f7</span> <span class="o">=</span> <span class="nx">factorialGenerator</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f3</span><span class="p">,</span> <span class="nx">f7</span><span class="p">);</span>
</pre></div>


<div class="highlight"><pre><span class="mi">6</span> <span class="mi">5040</span>
</pre></div>


<p>That's how we use fibers, it is not easy to wrap your head around it from the first time and you don't need to. Most of the time you will be using an abstraction layer on top of fibers and <code>Fibers</code> comes with one built-in called <code>Future</code>. We will have a look at it in next blog-post. For now I want to finish with some words of wisdom:</p>
<blockquote>
<p>It took me time to realize: Fibers are just very structured goto</p>
</blockquote>
<ul>
<li>David Glasser</li>
</ul>
  </div>
  <div class="article_meta">
    <p>Category: <a href="http://devblog.me/category/misc.html">misc</a></p>
    <p>Comments: <a href="#" onclick="javascript:toggleComments();return false;">toggle</a></p>
  </div>

    <div id="article_comments" style="display:block">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
           var disqus_identifier = "fibers.html";
           (function() {
           var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
           dsq.src = 'http://zdeslavablog.disqus.com/embed.js';
           (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
    </div>

</article>

    <footer>
<p><a href="http://devblog.me/" class="button_accent">&larr; Back to Index</a></p>
<script language="javascript">
    function toggleComments() {
        var commentDiv = document.getElementById("article_comments");
        (commentDiv.style.display == "none") ? commentDiv.style.display = "block" : commentDiv.style.display = "none";
        return false;
    }
</script>
    </footer>

    <div id="ending_message">
      <p>&copy; Slava Kim. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/giulivo/pelican-svbhack" target="_blank">github</a>. .</p>
    </div>
  </main>
</body>
</html>